<template>
  <view class="test-page">
    <view class="header">
      <text class="title">å¾®ç”Ÿæ´»åˆ¸å§</text>
      <text class="subtitle">å¼€å‘æµ‹è¯•å…¥å£</text>
    </view>

    <!-- ä¸»åŒ…é¡µé¢ -->
    <view class="section">
      <view class="section-title">ä¸»åŒ…é¡µé¢</view>
      <view class="page-grid">
        <view class="page-item" @click="goTo('/pages/login/index')">
          <text class="icon">ğŸ”</text>
          <text class="name">ç™»å½•é¡µ</text>
        </view>
        <view class="page-item" @click="switchTo('/pages/tabbar/home/index')">
          <text class="icon">ğŸ </text>
          <text class="name">é¦–é¡µ</text>
        </view>
        <view class="page-item" @click="switchTo('/pages/tabbar/activity/index')">
          <text class="icon">ğŸ‰</text>
          <text class="name">æ´»åŠ¨å¹¿åœº</text>
        </view>
        <view class="page-item" @click="switchTo('/pages/tabbar/mine/index')">
          <text class="icon">ğŸ‘¤</text>
          <text class="name">æˆ‘çš„</text>
        </view>
      </view>
    </view>

    <!-- æ¶ˆè´¹è€…åˆ†åŒ… -->
    <view class="section">
      <view class="section-title">æ¶ˆè´¹è€…åˆ†åŒ… (Consumer)</view>
      <view class="page-grid">
        <view class="page-item" @click="goTo('/pages/consumer/equity/summary')">
          <text class="icon">ğŸ’</text>
          <text class="name">æƒç›Šæ€»è§ˆ</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/equity/expiring')">
          <text class="icon">â°</text>
          <text class="name">å³å°†è¿‡æœŸ</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/member/list')">
          <text class="icon">ğŸª</text>
          <text class="name">ä¼šå‘˜åˆ—è¡¨</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/member/detail?merchantId=test')">
          <text class="icon">ğŸ¬</text>
          <text class="name">ä¼šå‘˜è¯¦æƒ…</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/activity/detail?id=test')">
          <text class="icon">ğŸ“‹</text>
          <text class="name">æ´»åŠ¨è¯¦æƒ…</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/activity/nearby')">
          <text class="icon">ğŸ“</text>
          <text class="name">é™„è¿‘ä¼˜æƒ </text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/order/confirm?activityId=test')">
          <text class="icon">âœ…</text>
          <text class="name">ç¡®è®¤è®¢å•</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/order/list')">
          <text class="icon">ğŸ“¦</text>
          <text class="name">è®¢å•åˆ—è¡¨</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/order/detail?id=test')">
          <text class="icon">ğŸ“„</text>
          <text class="name">è®¢å•è¯¦æƒ…</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/voucher/list')">
          <text class="icon">ğŸ«</text>
          <text class="name">åˆ¸åˆ—è¡¨</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/voucher/detail?id=test')">
          <text class="icon">ğŸŸï¸</text>
          <text class="name">åˆ¸è¯¦æƒ…</text>
        </view>
        <view class="page-item" @click="goTo('/pages/consumer/message/list')">
          <text class="icon">ğŸ“¬</text>
          <text class="name">æ¶ˆæ¯ä¸­å¿ƒ</text>
        </view>
      </view>
    </view>

    <!-- å•†å®¶æ ¸é”€åˆ†åŒ… -->
    <view class="section">
      <view class="section-title">å•†å®¶æ ¸é”€åˆ†åŒ… (Merchant)</view>
      <view class="page-grid">
        <view class="page-item" @click="goTo('/pages/merchant/verification/scan')">
          <text class="icon">ğŸ“·</text>
          <text class="name">æ‰«ç æ ¸é”€</text>
        </view>
        <view class="page-item" @click="goTo('/pages/merchant/verification/record')">
          <text class="icon">ğŸ“Š</text>
          <text class="name">æ ¸é”€è®°å½•</text>
        </view>
        <view class="page-item" @click="goTo('/pages/merchant/employee/bind')">
          <text class="icon">ğŸ”—</text>
          <text class="name">å‘˜å·¥ç»‘å®š</text>
        </view>
      </view>
    </view>

    <!-- å•†æˆ·ç®¡ç†åˆ†åŒ… -->
    <view class="section">
      <view class="section-title">å•†æˆ·ç®¡ç†åˆ†åŒ… (Admin)</view>
      <view class="page-grid">
        <view class="page-item" @click="goTo('/pages/admin/dashboard')">
          <text class="icon">ğŸ“ˆ</text>
          <text class="name">å•†æˆ·ä¸­å¿ƒ</text>
        </view>
        <view class="page-item" @click="goTo('/pages/admin/activity/list')">
          <text class="icon">ğŸª</text>
          <text class="name">æ´»åŠ¨ç®¡ç†</text>
        </view>
        <view class="page-item" @click="goTo('/pages/admin/member/stats')">
          <text class="icon">ğŸ‘¥</text>
          <text class="name">ä¼šå‘˜ç»Ÿè®¡</text>
        </view>
        <view class="page-item" @click="goTo('/pages/admin/billing/onboarding')">
          <text class="icon">ğŸ’°</text>
          <text class="name">å…¥é©»è´¹</text>
        </view>
        <view class="page-item" @click="goTo('/pages/admin/billing/service-fee')">
          <text class="icon">ğŸ“‘</text>
          <text class="name">æœåŠ¡è´¹</text>
        </view>
        <view class="page-item" @click="goTo('/pages/admin/order/list')">
          <text class="icon">ğŸ›’</text>
          <text class="name">è®¢å•ç®¡ç†</text>
        </view>
        <view class="page-item" @click="goTo('/pages/admin/settings')">
          <text class="icon">âš™ï¸</text>
          <text class="name">è®¾ç½®</text>
        </view>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="section">
      <view class="section-title">å¿«æ·æ“ä½œ</view>
      <view class="action-list">
        <button class="action-btn" @click="mockLogin">æ¨¡æ‹Ÿç™»å½• (æ¶ˆè´¹è€…)</button>
        <button class="action-btn merchant" @click="mockMerchantLogin">æ¨¡æ‹Ÿç™»å½• (å•†æˆ·)</button>
        <button class="action-btn danger" @click="clearStorage">æ¸…é™¤ç¼“å­˜</button>
      </view>
    </view>

    <!-- çŠ¶æ€ä¿¡æ¯ -->
    <view class="section status-section">
      <view class="section-title">å½“å‰çŠ¶æ€</view>
      <view class="status-list">
        <view class="status-item">
          <text class="label">ç™»å½•çŠ¶æ€:</text>
          <text class="value" :class="{ success: isLoggedIn }">{{ isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•' }}</text>
        </view>
        <view class="status-item">
          <text class="label">ç”¨æˆ·è§’è‰²:</text>
          <text class="value">{{ userRole || 'æ— ' }}</text>
        </view>
        <view class="status-item">
          <text class="label">Token:</text>
          <text class="value token">{{ tokenPreview }}</text>
        </view>
      </view>
    </view>

    <view class="footer">
      <text>WSH Mini-App v1.0.0 | å¼€å‘æµ‹è¯•ç‰ˆ</text>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { onShow } from '@dcloudio/uni-app'
import { useUserStore } from '@/store/user'
import { setToken, clearToken } from '@/api/request'

const userStore = useUserStore()

const isLoggedIn = computed(() => userStore.isLoggedIn)
const userRole = computed(() => userStore.role)
const tokenPreview = computed(() => {
  const token = userStore.token
  if (!token) return 'æ— '
  if (token.length > 20) {
    return token.slice(0, 10) + '...' + token.slice(-6)
  }
  return token
})

const goTo = (url: string) => {
  uni.navigateTo({ url })
}

const switchTo = (url: string) => {
  uni.switchTab({ url })
}

const mockLogin = () => {
  // æ¨¡æ‹Ÿæ¶ˆè´¹è€…ç™»å½•ï¼ˆä¸åç«¯ local profile Mock Token å¯¹é½ï¼‰
  const mockToken = 'mock_user_token_100001'
  setToken(mockToken)
  userStore.setUserInfo({
    token: mockToken,
    userId: '100001',
    openid: 'mock_openid_001',
    nickname: 'æµ‹è¯•ç”¨æˆ·',
    avatarUrl: '',
    phone: '13800138000',
    role: 'consumer'
  })
  uni.showToast({ title: 'å·²æ¨¡æ‹Ÿç™»å½•(æ¶ˆè´¹è€…)', icon: 'success' })
}

const mockMerchantLogin = () => {
  // æ¨¡æ‹Ÿå•†æˆ·ç™»å½•ï¼ˆä¸åç«¯ local profile Mock Token å¯¹é½ï¼‰
  const mockToken = 'mock_merchant_token_200001'
  setToken(mockToken)
  userStore.setUserInfo({
    token: mockToken,
    userId: '200001',
    openid: 'mock_openid_002',
    nickname: 'æµ‹è¯•å•†æˆ·ï¼ˆè€ç‹çƒ¤é±¼ï¼‰',
    avatarUrl: '',
    phone: '13900139000',
    role: 'merchant'
  })
  uni.showToast({ title: 'å·²æ¨¡æ‹Ÿç™»å½•(å•†æˆ·)', icon: 'success' })
}

const clearStorage = () => {
  uni.showModal({
    title: 'ç¡®è®¤æ¸…é™¤',
    content: 'å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜æ•°æ®ï¼ŒåŒ…æ‹¬ç™»å½•çŠ¶æ€',
    success: (res) => {
      if (res.confirm) {
        clearToken()
        userStore.logout()
        uni.clearStorageSync()
        uni.showToast({ title: 'å·²æ¸…é™¤', icon: 'success' })
      }
    }
  })
}

// é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°çŠ¶æ€
onShow(() => {
  userStore.checkLoginStatus()
})
</script>

<style lang="scss">
.test-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 24rpx;
  padding-bottom: 60rpx;
}

.header {
  text-align: center;
  padding: 40rpx 0;
  color: #fff;
  
  .title {
    display: block;
    font-size: 48rpx;
    font-weight: bold;
  }
  
  .subtitle {
    display: block;
    font-size: 26rpx;
    opacity: 0.8;
    margin-top: 12rpx;
  }
}

.section {
  background: #fff;
  border-radius: 20rpx;
  padding: 24rpx;
  margin-bottom: 24rpx;
}

.section-title {
  font-size: 28rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 20rpx;
  padding-bottom: 16rpx;
  border-bottom: 1rpx solid #f0f0f0;
}

.page-grid {
  display: flex;
  flex-wrap: wrap;
  margin: -8rpx;
}

.page-item {
  width: 25%;
  padding: 8rpx;
  box-sizing: border-box;
  
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20rpx 8rpx;
  
  .icon {
    font-size: 40rpx;
    margin-bottom: 8rpx;
  }
  
  .name {
    font-size: 22rpx;
    color: #666;
    text-align: center;
    line-height: 1.3;
  }
  
  &:active {
    background: #f5f5f5;
    border-radius: 12rpx;
  }
}

.action-list {
  display: flex;
  flex-direction: column;
  gap: 16rpx;
}

.action-btn {
  padding: 20rpx;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  font-size: 28rpx;
  border-radius: 12rpx;
  border: none;
  
  &.merchant {
    background: linear-gradient(135deg, #ff6b35, #f7931e);
  }
  
  &.danger {
    background: #f5f5f5;
    color: #f44336;
  }
}

.status-section {
  .status-list {
    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12rpx 0;
      border-bottom: 1rpx solid #f5f5f5;
      
      &:last-child {
        border-bottom: none;
      }
      
      .label {
        font-size: 26rpx;
        color: #999;
      }
      
      .value {
        font-size: 26rpx;
        color: #333;
        
        &.success {
          color: #4caf50;
        }
        
        &.token {
          font-family: monospace;
          font-size: 22rpx;
          color: #666;
          max-width: 300rpx;
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }
    }
  }
}

.footer {
  text-align: center;
  padding: 32rpx 0;
  
  text {
    font-size: 22rpx;
    color: rgba(255, 255, 255, 0.6);
  }
}
</style>
